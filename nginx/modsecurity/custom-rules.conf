# Custom ModSecurity rules for Transcendence application

# === API Rate Limiting Rules ===

# Limit all API requests (global rate limiting)
SecRule REQUEST_URI "@beginsWith /api" \
    "id:10000,\
    phase:1,\
    pass,\
    nolog,\
    setvar:ip.api_request=+1,\
    expirevar:ip.api_request=60"

SecRule IP:API_REQUEST "@gt 10" \
    "id:10001,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'API rate limit exceeded'"

# Specific login endpoint rate limiting
SecRule REQUEST_URI "@beginsWith /api/v1/auth/login" \
    "id:10002,\
    phase:1,\
    pass,\
    nolog,\
    setvar:ip.auth_attempt=+1,\
    expirevar:ip.auth_attempt=60"

SecRule IP:AUTH_ATTEMPT "@gt 5" \
    "id:10003,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'Potential brute force attempt detected'"

# === JSON Request Validation ===

# Require Content-Type:application/json for POST/PUT requests to API endpoints
SecRule REQUEST_METHOD "@rx ^(POST|PUT)$" \
    "chain,\
    id:10004,\
    phase:1,\
    block,\
    status:415,\
    log,\
    msg:'Content-Type must be application/json for POST/PUT requests to API'"
    SecRule REQUEST_URI "@beginsWith /api/" \
        "chain"
        SecRule REQUEST_HEADERS:Content-Type "!@rx application/json" "t:none"

# Block requests with excessive JSON nesting (potential DoS)
SecRule REQUEST_HEADERS:Content-Type "@rx application/json" \
    "id:10005,\
    phase:2,\
    block,\
    t:none,\
    status:400,\
    log,\
    msg:'JSON request body has excessive nesting',\
    chain"
    SecRule REQUEST_BODY "@rx (\{[^\{\}]*){10,}" "t:none"

# === Game Service Protection ===

# Prevent game manipulation and cheating attempts
SecRule REQUEST_URI "@beginsWith /api/v1/games" \
    "chain,\
    id:10006,\
    phase:2,\
    block,\
    status:403,\
    log,\
    msg:'Potential game manipulation attempt'"
    SecRule REQUEST_BODY "@rx (speed|position|score|winStatus|gameState).*(=|:).*([0-9]{4,})" "t:none,t:lowercase"

# === File Upload Protection ===

# Restrict avatar uploads to image files only
SecRule REQUEST_URI "@rx /api/v1/users/[0-9]+/avatar" \
    "chain,\
    id:10007,\
    phase:2,\
    block,\
    status:415,\
    log,\
    msg:'Invalid file type for avatar upload'"
    SecRule FILES:avatar|FILES_NAMES:/.*/ "!@rx (?i).*\.(jpg|jpeg|png|gif)$" "t:none"

# === JWT Token Protection ===

# Check for JWT token tampering by verifying token format
SecRule REQUEST_HEADERS:Authorization "@rx Bearer\s+([^.]+)\.([^.]+)\.([^.]+)" \
    "id:10008,\
    phase:1,\
    pass,\
    nolog,\
    capture,\
    setvar:tx.jwt_header=%{TX.1},\
    setvar:tx.jwt_payload=%{TX.2},\
    setvar:tx.jwt_signature=%{TX.3}"

SecRule TX:JWT_HEADER "!@rx ^[A-Za-z0-9\-_]+$" \
    "id:10009,\
    phase:1,\
    deny,\
    status:401,\
    log,\
    msg:'Malformed JWT token'"

# === Path Traversal Protection ===

# Enhanced path traversal protection for URLs
SecRule REQUEST_URI "@rx (?:\.\.|%2e%2e|%252e%252e)" \
    "id:10010,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Path traversal attempt in URL',\
    t:none,t:urlDecodeUni,t:lowercase"

# Block path traversal attempts in query parameters
SecRule ARGS_NAMES|ARGS "@rx (?:\.\.|%2e%2e|%252e|%252e%252e)" \
    "id:10011,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Path traversal attempt in query parameter',\
    t:none,t:urlDecodeUni,t:lowercase"

# === Command Injection Protection ===

# Block command injection attacks
SecRule ARGS|ARGS_NAMES "@rx (?:;|\||`|\$\(|\$\{|&&|\|\||>|<|>>|<<|2>)" \
    "id:10012,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Command injection attempt detected',\
    t:none,t:urlDecodeUni,t:lowercase"

# === Specific Attack Protection ===

# Block NoSQL injection attempts 
SecRule ARGS_NAMES|ARGS "@rx \$(?:eq|ne|gt|gte|lt|lte|in|nin|or|nor|and|not|exists|type|mod|regex|where|all|size|elemMatch)" \
    "id:10013,\
    phase:2,\
    block,\
    status:403,\
    log,\
    msg:'Potential NoSQL injection attempt',\
    t:none,t:urlDecodeUni"

# Block socket.io abuse
SecRule REQUEST_URI "@beginsWith /socket.io" \
    "chain,\
    id:10014,\
    phase:1,\
    pass,\
    nolog,\
    setvar:ip.socket_conn=+1,\
    expirevar:ip.socket_conn=60"

SecRule IP:SOCKET_CONN "@gt 30" \
    "id:10015,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'Socket.io connection flood'"

# === User Input Validation ===

# Username and display name format validation
SecRule REQUEST_URI "@rx /api/v1/auth/register" \
    "chain,\
    id:10016,\
    phase:2,\
    block,\
    status:400,\
    log,\
    msg:'Invalid username format'"
    SecRule REQUEST_BODY "@rx \"username\"\\s*:\\s*\"[^A-Za-z0-9_\\-]{1,20}\"" "t:none"

# === SQL Injection Protection ===

# Block basic SQL injection patterns
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i:select|union|insert|update|delete|drop|alter)" \
    "id:20000,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SQL Injection attempt detected'"

# More comprehensive SQL injection pattern
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)(union\s+all\s+select|select\s+from|select\s+count|select\s+1\s+from)" \
    "id:20001,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Advanced SQL Injection attempt detected'"

# Block single quote and comment SQL injection
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx ['\"]\s*(\s|and|or|procedure)\s*['\"]" \
    "id:20002,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SQL Injection with quotes detected'"

# === XSS Protection ===

# Block common XSS patterns
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i:<script|javascript:|<img|onerror=|onload=)" \
    "id:30000,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XSS attempt detected'"

# Additional XSS patterns
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i:<[a-z]+\s+.*on[a-z]+\s*=)" \
    "id:30001,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XSS event handler attempt detected'"

# More XSS vectors
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i:alert\(|eval\(|document\.cookie|document\.location)" \
    "id:30002,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'JavaScript code injection attempt detected'"

# === Test Route Protection ===

# Ensure the test route used in waf-test.sh returns 403 for attack attempts
SecRule REQUEST_URI "@beginsWith /api/test" \
    "chain,\
    id:40000,\
    phase:1,\
    pass,\
    nolog"
    SecRule ARGS "@rx (?:select|union|insert|update|delete|drop|alter|<script|javascript:|<img|onerror=|onload=|\.\.|%2e%2e|%252e%252e|;|\||`|\$\(|\$\{|&&|\|\||>|<|>>)" \
        "deny,\
        status:403,\
        log,\
        msg:'Attack attempt detected on test endpoint'" 