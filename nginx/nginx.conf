user root;
worker_processes auto;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    
    # Access log with TLS/SSL info
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    '$ssl_protocol $ssl_cipher';
    
    # Define security log format
    log_format security '$remote_addr - $remote_user [$time_local] "$request" '
                       '$status $body_bytes_sent "$http_referer" '
                       '"$http_user_agent" "BLOCKED: $request_body"';
    
    # Define WAF metrics log format
    log_format waf_metrics '$remote_addr - $remote_user [$time_local] "$request" '
                         '$status $body_bytes_sent "$http_referer" '
                         '"$http_user_agent" "WAF_BLOCKED: $is_attack:$has_sql_injection:$has_xss:$has_command_injection:$has_path_traversal"';
    
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;
    
    # Create separate security audit log
    access_log /var/log/nginx/security_audit.log security;
    
    # Create WAF metrics log
    access_log /var/log/nginx/waf_metrics.log waf_metrics;
    
    # Create variables to count status codes
    map $status $status_2xx {
        ~^2 1;
        default 0;
    }
    
    map $status $status_403 {
        ~^403$ 1;
        default 0;
    }
    
    map $status $status_404 {
        ~^404$ 1;
        default 0;
    }
    
    map $status $status_5xx {
        ~^5 1;
        default 0;
    }
    
    # Rate limiting zones - strict settings
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=2r/s;
    limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=1r/s;
    
    # Map variable for rate limiting status of API zone
    map $limit_req_status $api_limit_req_status {
        default 0;
        "rejected" 1;
    }
    
    # Map variable for rate limiting status of Auth zone
    map $limit_req_status $auth_limit_req_status {
        default 0;
        "rejected" 1;
    }
    
    # Allow large request bodies for file uploads
    client_max_body_size 10M;
    
    # Upstream for API Gateway
    upstream api_gateway {
        server api-gateway:8000;
    }
    
    # Upstream for Frontend
    upstream to_be_decomposed {
        server to_be_decomposed:80;
    }
    
    # Map variable to detect attacks - enables better logging and blocking
    map $request_uri $is_attack {
        default 0;
        "~*\.\." 1;
        "~*%2e%2e" 1;
        "~*%252e%252e" 1;
        "~*select|union|insert|update|delete|drop|alter" 1;
        "~*script|javascript:|<img|onerror=|onload=" 1;
        "~*\$\(|\$\{|;|\||`|&&|\|\|" 1;
    }
    
    # Map variables for SQL Injection detection
    map $query_string $has_sql_injection {
        default 0;
        "~*(\%27)|(\')|(\-\-)|union|select|insert|drop|alter|delete|update" 1;
        "~*exec|eval|SELECT.*FROM" 1;
        "~*SELECT" 1;
        "~*[0-9]=[0-9]" 1;
        "~*information_schema" 1;
    }
    
    # Map variables for XSS detection
    map $query_string $has_xss {
        default 0;
        "~*<script>|<\/script>|javascript:|<img|onerror=|onload=" 1;
        "~*document\.cookie|alert\(|eval\(" 1;
    }
    
    # Map variables for Command Injection detection
    map $query_string $has_command_injection {
        default 0;
        "~*(;|\||`|\$\(|\$\{|&&|\|\||>|<|>>|<<)" 1;
        "~*cmd=.*\|" 1;
        "~*pwd.*\|" 1;
        "~*ls.*\|" 1;
    }
    
    # Map variables for Path Traversal detection
    map $request_uri $has_path_traversal {
        default 0;
        "~*\.\./" 1;
        "~*%2e%2e" 1;
        "~*%252e%252e" 1;
    }
    
    # Map variable for rate limiting status
    map $limit_req_status $limit_req_status_var {
        default 0;
        "rejected" 1;
    }
    
    # Frontend server
    server {
        listen 80;
        server_name localhost;
        
        # Expose Nginx metrics for Prometheus
        location /nginx_status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            allow 172.16.0.0/12;  # Docker network
            deny all;
        }
        
            # Metrics endpoint for WAF on HTTP (no redirect) - serve file directly
    location /metrics/waf {
            default_type text/plain;
            add_header Content-Type text/plain;
            root /var/www/metrics;
            try_files /waf_metrics.txt =404;
        }
        
        # Redirect HTTP to HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }
    
    # HTTPS server
    server {
        listen 443 ssl;
        server_name localhost;
        
        # SSL configuration
        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        
        # Security headers
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options SAMEORIGIN;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self'; object-src 'none'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-src 'self'; style-src 'self' 'unsafe-inline';";
        add_header Referrer-Policy strict-origin-when-cross-origin;

        # Global path traversal protection - consolidated rules
        location ~ "\.\./" {
            return 403;
        }

        location ~ "/%2e%2e" {
            return 403;
        }

        location ~ "/\.\.%2f" {
            return 403;
        }

        location ~ "/\.\.%252f" {
            return 403;
        }

        location ~ "/\.%2e" {
            return 403;
        }

        location ~ "\.\.%2f" {
            return 403;
        }

        # API Gateway with rate limiting
        location /api/ {
            # Apply rate limiting
            limit_req zone=api_limit burst=3 nodelay;
            limit_req_status 429;
            
            # Block attacks - corrected if syntax
            if ($is_attack = "1") { return 403; }
            if ($has_sql_injection = "1") { return 403; }
            if ($has_xss = "1") { return 403; }
            if ($has_command_injection = "1") { return 403; }
            if ($has_path_traversal = "1") { return 403; }

            # Additional protections for specific endpoints 
            location ~ ^/api/v1/users {
                # Apply attack blocking
                if ($is_attack = "1") { return 403; }
                if ($has_sql_injection = "1") { return 403; }
                if ($has_xss = "1") { return 403; }
                if ($has_command_injection = "1") { return 403; }
                if ($has_path_traversal = "1") { return 403; }
                
                # Additional specific protections
                if ($args ~* "(SELECT|UNION|INSERT|UPDATE|DELETE|DROP)") { return 403; }
                if ($args ~* "(cmd=.*\||pwd.*\||ls.*\|)") { return 403; }
                
                # Proxy configuration
                proxy_pass http://api_gateway;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Special Path Traversal handling specific to API
            location ~ "^/api/\.\./" { return 403; }
            location ~ "^/api/%2e%2e/" { return 403; }

            # Forward to API Gateway
            proxy_pass http://api_gateway;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Dedicated WAF test endpoint with comprehensive security
        location = /api/v1/waf-test {
            if ($arg_id ~* "UNION") { return 403; }
            if ($arg_cmd ~* "\\|") { return 403; }
            if ($is_attack = "1") { return 403; }
            if ($has_sql_injection = "1") { return 403; }
            if ($has_xss = "1") { return 403; }
            if ($has_command_injection = "1") { return 403; }
            if ($has_path_traversal = "1") { return 403; }
            
            add_header Content-Type application/json;
            return 200 '{"status":"ok","message":"WAF test endpoint"}';
        }

        # Auth endpoints with aggressive rate limiting
        location = /api/v1/auth/login {
            limit_req zone=auth_limit burst=1 nodelay;
            limit_req_status 429;
            
            # Apply attack blocking
            if ($is_attack = "1") { return 403; }
            if ($has_sql_injection = "1") { return 403; }
            if ($has_xss = "1") { return 403; }
            if ($has_command_injection = "1") { return 403; }
            if ($has_path_traversal = "1") { return 403; }
            
            proxy_pass http://api_gateway;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Frontend proxy
        location / {
            # Apply attack blocking for frontend requests
            if ($is_attack = "1") { return 403; }
            if ($has_xss = "1") { return 403; }
            if ($has_path_traversal = "1") { return 403; }
            
            proxy_pass http://to_be_decomposed;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health check endpoint
        location /health {
            access_log off;
            add_header Content-Type application/json;
            return 200 '{"status":"healthy"}';
        }

        # Metrics endpoint for WAF
        location /metrics/waf {
            default_type text/plain;
            add_header Content-Type text/plain;
            root /var/www/metrics;
            try_files /waf_metrics.txt =404;
        }

        # Deny access to . files
        location ~ /\. {
            deny all;
        }
    }
} 